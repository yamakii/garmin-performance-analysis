# ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ
{% set training_type_category = training_type_category|default("low_moderate") -%}
{%- set show_physiological = training_type_category in ["tempo_threshold", "interval_sprint"] -%}
{%- set is_interval = training_type_category == "interval_sprint" %}

## åŸºæœ¬æƒ…å ±
- **æ—¥ä»˜**: {{ date }}
- **ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ID**: {{ activity_id }}
{% if activity_name %}- **ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å**: {{ activity_name }}{% endif %}
{% if basic_metrics.start_time %}- **é–‹å§‹æ™‚åˆ»**: {{ basic_metrics.start_time }}{% endif %}
{% if basic_metrics.distance_km %}- **è·é›¢**: {{ "%.2f"|format(basic_metrics.distance_km) }} km{% endif %}
{% if basic_metrics.duration_seconds %}- **æ‰€è¦æ™‚é–“**: {{ (basic_metrics.duration_seconds // 60)|int }}åˆ†{{ "%02d"|format((basic_metrics.duration_seconds % 60)|int) }}ç§’ ({{ basic_metrics.duration_seconds|int }}ç§’){% endif %}
{% if basic_metrics.avg_pace_seconds_per_km %}- **å¹³å‡ãƒšãƒ¼ã‚¹**: {{ (basic_metrics.avg_pace_seconds_per_km / 60)|int }}:{{ "%02d"|format((basic_metrics.avg_pace_seconds_per_km % 60)|int) }}/km{% endif %}
- **[Garmin Connectã§è¦‹ã‚‹](https://connect.garmin.com/modern/activity/{{ activity_id }})**

---

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚µãƒãƒªãƒ¼
{%- if show_physiological and lactate_threshold_data %}

### ç”Ÿç†å­¦çš„æŒ‡æ¨™ã‚µãƒãƒªãƒ¼

| æŒ‡æ¨™ | ç¾åœ¨å€¤ | è©•ä¾¡ |
|------|--------|------|
{%- if vo2_max_data %}
| **VO2 Max** | {{ vo2_max_data.precise_value|default(vo2_max_data.value)|default(0) }} ml/kg/min | ã‚«ãƒ†ã‚´ãƒª: {{ vo2_max_data.category|default("N/A") }} |
{%- endif %}
{%- if vo2_max_utilization %}
| **VO2 Maxåˆ©ç”¨ç‡** | {{ vo2_max_utilization }}% | {{ vo2_max_utilization_eval|default("N/A") }} |
{%- endif %}
| **é–¾å€¤ãƒšãƒ¼ã‚¹** | {{ threshold_pace_formatted|default("N/A") }} | {{ threshold_pace_comparison|default("N/A") }} |
| **FTP(ãƒ‘ãƒ¯ãƒ¼)** | {{ lactate_threshold_data.functional_threshold_power|default(0)|int }} W | Workå¹³å‡{{ work_avg_power|int if work_avg_power else "N/A" }}W = FTPã®{{ ftp_percentage|default("N/A") }}% |

{% endif %}

### é¡ä¼¼ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã¨ã®æ¯”è¼ƒ

{%- if similar_workouts %}
{%- if similar_workouts.pace_source == "main_set" %}
éå»ã®åŒæ¡ä»¶ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆï¼ˆ{{ similar_workouts.conditions }}ã€**ãƒ¡ã‚¤ãƒ³ã‚»ãƒƒãƒˆãƒšãƒ¼ã‚¹æ¯”è¼ƒ**ï¼‰ã¨ã®æ¯”è¼ƒï¼š
{%- else %}
éå»ã®åŒæ¡ä»¶ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆï¼ˆ{{ similar_workouts.conditions }}ï¼‰ã¨ã®æ¯”è¼ƒï¼š
{%- endif %}

| æŒ‡æ¨™ | ä»Šå› | é¡ä¼¼{{ similar_workouts.count }}å›å¹³å‡ | å¤‰åŒ– | ãƒˆãƒ¬ãƒ³ãƒ‰ |
|------|------|------------|------|----------|
{%- for comp in similar_workouts.comparisons %}
| {{ comp.metric }} | {{ comp.current }} | {{ comp.average }} | {{ comp.change }} | {{ comp.trend }} |
{%- endfor %}

**ğŸ’¡ ã‚¤ãƒ³ã‚µã‚¤ãƒˆ**: {{ similar_workouts.insight }}
{%- else %}
é¡ä¼¼ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
{%- endif %}
{%- if reference_info %}

{{ reference_info }}
{%- endif %}

---

## ç·åˆè©•ä¾¡
{%- if summary %}

### ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚¿ã‚¤ãƒ—
{%- if activity_type %}
**{{ activity_type.ja }}** ({{ activity_type.en }})

{{ activity_type.description }}
{%- else %}
N/A
{%- endif %}

### ç·åˆæ‰€è¦‹{% if summary.star_rating %} ({{ summary.star_rating }}){% endif %}

{{ summary.summary if summary.summary else "è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚" }}

{% if summary.key_strengths %}
**âœ… å„ªã‚Œã¦ã„ã‚‹ç‚¹:**
{% for strength in summary.key_strengths -%}
- {{ strength }}
{% endfor %}
{% endif %}

{% if summary.improvement_areas %}
**âš ï¸ æ”¹å–„å¯èƒ½ãªç‚¹:**
{% for area in summary.improvement_areas -%}
- {{ area }}
{% endfor %}
{% endif %}
{% endif %}

### ãƒšãƒ¼ã‚¹ãƒ»å¿ƒæ‹{% if show_physiological %}ãƒ»ãƒ‘ãƒ¯ãƒ¼{% endif %}æ¨ç§»{% if is_interval %}(Work/Recoveryãƒã‚¤ãƒ©ã‚¤ãƒˆ){% endif %}

{% if mermaid_data %}
```mermaid
xychart-beta
    title "ã‚¹ãƒ—ãƒªãƒƒãƒˆåˆ¥ ãƒšãƒ¼ã‚¹ãƒ»å¿ƒæ‹{% if show_physiological %}ãƒ»ãƒ‘ãƒ¯ãƒ¼{% endif %}æ¨ç§»"
    x-axis {{ mermaid_data.x_axis_labels | tojson }}
    y-axis "ãƒšãƒ¼ã‚¹(ç§’/km)" {{ mermaid_data.pace_min }} --> {{ mermaid_data.pace_max }}
    y-axis "å¿ƒæ‹(bpm)" {{ mermaid_data.hr_min }} --> {{ mermaid_data.hr_max }}
    line {{ mermaid_data.pace_data | tojson }}
    line {{ mermaid_data.heart_rate_data | tojson }}
    {% if show_physiological and mermaid_data.power_data %}
    line {{ mermaid_data.power_data | tojson }}
    {% endif %}
```

{% if is_interval %}
**å‡¡ä¾‹**: é’=ãƒšãƒ¼ã‚¹(ç§’/km)ã€æ©™=å¿ƒæ‹(bpm)ã€ç·‘=ãƒ‘ãƒ¯ãƒ¼(W)

**åˆ†æ**:
{{ interval_graph_analysis|default("N/A") }}
{% endif %}
{% else %}
ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
{% endif %}

---

{# =================================================================== #}
{# SECTION 4: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ #}
{# =================================================================== #}
## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™

{% if is_interval %}
> **è©•ä¾¡å¯¾è±¡**: {{ target_segments_description|default("Workã‚»ã‚°ãƒ¡ãƒ³ãƒˆ") }}(ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«èµ°ã¯é«˜å¼·åº¦åŒºé–“ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’é‡è¦–)
{% endif %}

### ã‚¹ãƒ—ãƒªãƒƒãƒˆæ¦‚è¦{% if is_interval %}(å…¨åŒºé–“){% endif %}

{% if splits and splits|length > 0 %}
| # | {% if is_interval %}ã‚¿ã‚¤ãƒ— | {% endif %}ãƒšãƒ¼ã‚¹ | å¿ƒæ‹ | ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹ | ãƒ‘ãƒ¯ãƒ¼ | ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ | GCT | VO | VR | æ¨™é«˜ |
|---|{% if is_interval %}-------|{% endif %}--------|------|------------|--------|------------|-----|----|----|------|
{%- for split in splits %}
| {{ split.index }} | {% if is_interval %}{{ splits|format_intensity_type(split.index) }} | {% endif %}{{ split.pace_formatted }}/km | {{ split.heart_rate|int }} bpm | {{ split.cadence|int if split.cadence else "-" }} spm | {{ split.power|int if split.power else "-" }} W | {{ "%.2f"|format(split.stride_length) if split.stride_length else "-" }} m | {{ split.ground_contact_time|int if split.ground_contact_time else "-" }} ms | {{ "%.1f"|format(split.vertical_oscillation) if split.vertical_oscillation else "-" }} cm | {{ "%.1f"|format(split.vertical_ratio) if split.vertical_ratio else "-" }}% | +{{ split.elevation_gain|int if split.elevation_gain else 0 }}/-{{ split.elevation_loss|int if split.elevation_loss else 0 }}m |
{%- endfor %}

**ğŸ“ˆ {% if is_interval %}Workã‚»ã‚°ãƒ¡ãƒ³ãƒˆ {% endif %}ãƒã‚¤ãƒ©ã‚¤ãƒˆ:**
{{ highlights_list|default("N/A") }}

<details>
<summary>ğŸ“‹ {% if is_interval %}Work/Recovery{% else %}ã‚¹ãƒ—ãƒªãƒƒãƒˆ{% endif %}è©³ç´°åˆ†æ(ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹)</summary>

{% if split_analysis %}
{% if split_analysis is mapping %}
{%- set analyses_dict = split_analysis.get("analyses", split_analysis) %}
{% for key, value in analyses_dict.items() | sort_splits %}
### {{ key }}
{{ value }}

{% endfor %}
{% else %}
{{ split_analysis }}
{% endif %}
{% else %}
è©³ç´°åˆ†æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
{% endif %}

</details>
{% else %}
ã‚¹ãƒ—ãƒªãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
{% endif %}

---

{% set efficiency_text = efficiency.efficiency_text if efficiency.efficiency_text else efficiency.evaluation if efficiency.evaluation else efficiency if efficiency is string else "ãƒ•ã‚©ãƒ¼ãƒ åŠ¹ç‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚" %}
{% set efficiency_rating = efficiency_text|extract_star_rating %}
### ãƒ•ã‚©ãƒ¼ãƒ åŠ¹ç‡{% if is_interval %}ï¼ˆWorkã‚»ã‚°ãƒ¡ãƒ³ãƒˆï¼‰{% endif %}{% if form_evaluation %}{% if form_evaluation.integrated_score %} ({{ form_evaluation.integrated_score|round(1) }}/100ç‚¹ {{ form_evaluation.overall_star_rating }}){% else %} ({{ form_evaluation.overall_star_rating }} {{ form_evaluation.overall_score|round(1) }}/5.0){% endif %}{% elif efficiency.overall_form_score %} ({{ efficiency.overall_form_score }}){% elif efficiency_rating.score > 0 %} ({{ efficiency_rating.stars }} {{ efficiency_rating.score }}/5.0){% endif %}

{% if form_evaluation %}
{# Phase 5: Unified Form Evaluation System - Use form_evaluations table #}

{% if heart_rate_zone_pie_data %}
```mermaid
pie title "å¿ƒæ‹ã‚¾ãƒ¼ãƒ³åˆ†å¸ƒ"
{{ heart_rate_zone_pie_data }}
```
{% endif %}

#### æŒ‡æ¨™è©³ç´°

| æŒ‡æ¨™ | å®Ÿæ¸¬å€¤ | æœŸå¾…å€¤ | åå·® | è©•ä¾¡ |
|------|--------|--------|------|------|
| **æ¥åœ°æ™‚é–“ (GCT)** | {{ form_evaluation.gct.actual|round(1) }}ms | {{ form_evaluation.gct.expected|round(1) }}ms | {{ form_evaluation.gct.delta_pct|round(1) }}% | {{ form_evaluation.gct.star_rating }} {{ form_evaluation.gct.score|round(1) }}/5.0 |
| **å‚ç›´æŒ¯å¹… (VO)** | {{ form_evaluation.vo.actual|round(2) }}cm | {{ form_evaluation.vo.expected|round(2) }}cm | {{ form_evaluation.vo.delta_pct|round(1) }}% | {{ form_evaluation.vo.star_rating }} {{ form_evaluation.vo.score|round(1) }}/5.0 |
| **å‚ç›´æ¯”ç‡ (VR)** | {{ form_evaluation.vr.actual|round(2) }}% | {{ form_evaluation.vr.expected|round(2) }}% | {{ form_evaluation.vr.delta_pct|round(1) }}% | {{ form_evaluation.vr.star_rating }} {{ form_evaluation.vr.score|round(1) }}/5.0 |
{% if form_evaluation.power and form_evaluation.power.avg_w -%}
| **ãƒ‘ãƒ¯ãƒ¼åŠ¹ç‡** | {{ form_evaluation.power.avg_w|round(0) }}W ({{ form_evaluation.power.wkg|round(2) }}W/kg) | {{ form_evaluation.power.speed_expected_mps|round(2) }}m/sæœŸå¾… | {{ (form_evaluation.power.efficiency_score * 100)|round(1) }}% | {{ form_evaluation.power.star_rating }} |
{% endif -%}
| **ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹** | {{ form_evaluation.cadence.actual|round(0) }}spm | {{ form_evaluation.cadence.minimum }}spmä»¥ä¸Š | - | {% if form_evaluation.cadence.achieved %}âœ“ é”æˆ{% elif form_evaluation.cadence.actual >= 178 %}ã»ã¼é”æˆ{% elif form_evaluation.cadence.actual >= 175 %}è¨±å®¹ç¯„å›²{% else %}è¦æ”¹å–„{% endif %} |

{% if form_evaluation.integrated_score -%}
**ç·åˆè©•ä¾¡: {{ form_evaluation.integrated_score|round(1) }}/100ç‚¹ ({{ form_evaluation.overall_star_rating }})** â€»ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰: {{ form_evaluation.training_mode|default("N/A") }}
{%- else -%}
**ç·åˆè©•ä¾¡: {{ form_evaluation.overall_star_rating }} {{ form_evaluation.overall_score|round(1) }}/5.0**
{%- endif %}

#### è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆ

{{ efficiency.efficiency if efficiency and efficiency.efficiency else efficiency_text }}

{% if efficiency and efficiency.evaluation %}
#### å¿ƒæ‹åŠ¹ç‡

{{ efficiency.evaluation }}
{% endif %}

{% if efficiency and efficiency.form_trend %}
#### ãƒ•ã‚©ãƒ¼ãƒ ãƒˆãƒ¬ãƒ³ãƒ‰

{{ efficiency.form_trend }}
{% endif %}

{% elif efficiency %}
{% if efficiency.form_efficiency_table or efficiency.form_indicators %}
{# New structured format #}
{% set form_table = efficiency.form_efficiency_table or efficiency.form_indicators %}

{% if heart_rate_zone_pie_data %}
```mermaid
pie title "å¿ƒæ‹ã‚¾ãƒ¼ãƒ³åˆ†å¸ƒ"
{{ heart_rate_zone_pie_data }}
```
{% endif %}

| æŒ‡æ¨™ | å®Ÿæ¸¬å€¤ | ãƒšãƒ¼ã‚¹åŸºæº–å€¤ | è£œæ­£ã‚¹ã‚³ã‚¢ | è©•ä¾¡ |
|------|--------|------------|-----------|------|
{%- for item in form_table %}
| **{{ item.metric_name }}** | {{ item.actual_value }} | {{ item.baseline_value }} | {{ item.adjusted_score }} | {{ item.rating }} |
{%- endfor %}

{% if efficiency.overall_form_score %}**ç·åˆãƒ•ã‚©ãƒ¼ãƒ åŠ¹ç‡: {{ efficiency.overall_form_score }}**{% endif %}

{% if efficiency.efficiency_text %}{{ efficiency.efficiency_text }}{% endif %}

{% if efficiency.hr_efficiency_text %}**å¿ƒæ‹åŠ¹ç‡:**
{{ efficiency.hr_efficiency_text }}{% endif %}
{% else %}
{# Legacy format #}
{% if is_interval %}
```mermaid
pie title "å¿ƒæ‹ã‚¾ãƒ¼ãƒ³åˆ†å¸ƒ(å…¨ä½“)"
{{ heart_rate_zone_pie_data|default("") }}
```
{% else %}
```mermaid
pie title "å¿ƒæ‹ã‚¾ãƒ¼ãƒ³åˆ†å¸ƒ"
{{ heart_rate_zone_pie_data|default("") }}
```
{% endif %}

{{ efficiency_rating.text_without_rating if efficiency_rating.score > 0 else efficiency_text }}
{% endif %}
{% else %}
ãƒ•ã‚©ãƒ¼ãƒ åŠ¹ç‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
{% endif %}

---

{% if show_physiological %}
{# =================================================================== #}
{# SECTION 5: ç”Ÿç†å­¦çš„æŒ‡æ¨™ã¨ã®é–¢é€£ (Tempo/Interval only) #}
{# =================================================================== #}
## ç”Ÿç†å­¦çš„æŒ‡æ¨™ã¨ã®é–¢é€£

### VO2 Maxæ´»ç”¨åº¦

{% if vo2_max_data %}
- **ç¾åœ¨ã®VO2 Max**: {{ vo2_max_data.precise_value|default(vo2_max_data.value)|default(0) }} ml/kg/min({{ vo2_max_data.category|default("N/A") }})
- **{% if is_interval %}Work{% else %}ãƒ¡ã‚¤ãƒ³åŒºé–“{% endif %}å¹³å‡å¿ƒæ‹**: {{ run_metrics.avg_hr|default("N/A")|int if run_metrics.avg_hr else "N/A" }} bpm
- **VO2 Maxåˆ©ç”¨ç‡**: ç´„{{ vo2_max_utilization|default("N/A") }}%({{ vo2_max_utilization_eval|default("N/A") }})

**æœŸå¾…åŠ¹æœ**: {{ vo2_max_expected_effect|default("N/A") }}
{% else %}
VO2 Maxãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
{% endif %}

### é–¾å€¤è¶…éåº¦

{% if lactate_threshold_data %}
- **é–¾å€¤å¿ƒæ‹**: {{ lactate_threshold_data.heart_rate|default(0)|int }} bpm
- **{% if is_interval %}Work{% else %}ãƒ¡ã‚¤ãƒ³åŒºé–“{% endif %}å¹³å‡å¿ƒæ‹**: {{ run_metrics.avg_hr|default("N/A")|int if run_metrics.avg_hr else "N/A" }} bpm
- **é–¾å€¤ãƒ‘ãƒ¯ãƒ¼(FTP)**: {{ lactate_threshold_data.functional_threshold_power|default(0)|int }} W
- **{% if is_interval %}Work{% else %}ãƒ¡ã‚¤ãƒ³åŒºé–“{% endif %}å¹³å‡ãƒ‘ãƒ¯ãƒ¼**: {{ work_avg_power|default("N/A")|int if work_avg_power else "N/A" }} W(FTPã®{{ ftp_percentage|default("N/A") }}%) â†’ {{ power_zone_name|default("N/A") }} âœ…

**æœŸå¾…åŠ¹æœ**: {{ threshold_expected_effect|default("N/A") }}
{% else %}
é–¾å€¤ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
{% endif %}

---

{% endif %}

{# =================================================================== #}
{# SECTION 6 (or 5): ãƒ•ã‚§ãƒ¼ã‚ºè©•ä¾¡ #}
{# =================================================================== #}
## ãƒ•ã‚§ãƒ¼ã‚ºè©•ä¾¡

{% if phase_evaluation %}
{% if phase_evaluation.get('warmup_evaluation') or phase_evaluation.get('warmup') or training_type_category == "recovery" %}
{%- set warmup_text = phase_evaluation.get('warmup_evaluation', phase_evaluation.get('warmup', {}).get('evaluation', 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚')) %}
### ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ãƒ•ã‚§ãƒ¼ã‚º{% if warmup_rating.score > 0 %} ({{ warmup_rating.stars }} {{ warmup_rating.score }}/5.0){% endif %}
{{ (warmup_text|extract_star_rating).text_without_rating }}

{%- if training_type_category == "recovery" %}
{# Recovery run - only 1 phase, end here #}
---
{%- endif %}
{%- endif %}

{%- if training_type_category != "recovery" %}
{%- if phase_evaluation.get('run_evaluation') or phase_evaluation.get('run') or phase_evaluation.get('main') %}
{%- set run_text = phase_evaluation.get('run_evaluation', phase_evaluation.get('run', {}).get('evaluation', phase_evaluation.get('main', {}).get('evaluation', 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'))) %}

---

### {% if is_interval %}Workãƒ•ã‚§ãƒ¼ã‚º{% else %}ãƒ¡ã‚¤ãƒ³èµ°è¡Œãƒ•ã‚§ãƒ¼ã‚º{% endif %}{% if run_rating.score > 0 %} ({{ run_rating.stars }} {{ run_rating.score }}/5.0){% endif %}
{{ (run_text|extract_star_rating).text_without_rating }}
{%- endif %}

{%- if is_interval and (phase_evaluation.get('recovery_evaluation') or phase_evaluation.get('recovery')) %}
{%- set recovery_text = phase_evaluation.get('recovery_evaluation', phase_evaluation.get('recovery', {}).get('evaluation', 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚')) %}

---

### Recoveryãƒ•ã‚§ãƒ¼ã‚º{% if recovery_rating.score > 0 %} ({{ recovery_rating.stars }} {{ recovery_rating.score }}/5.0){% endif %}
{{ (recovery_text|extract_star_rating).text_without_rating }}
{%- endif %}

{%- if phase_evaluation.get('cooldown_evaluation') or phase_evaluation.get('cooldown') or phase_evaluation.get('finish') %}
{%- set cooldown_text = phase_evaluation.get('cooldown_evaluation', phase_evaluation.get('cooldown', {}).get('evaluation', phase_evaluation.get('finish', {}).get('evaluation', 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'))) %}

---

### ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒ•ã‚§ãƒ¼ã‚º{% if cooldown_rating.score > 0 %} ({{ cooldown_rating.stars }} {{ cooldown_rating.score }}/5.0){% endif %}
{{ (cooldown_text|extract_star_rating).text_without_rating }}

---
{%- endif %}

{%- if phase_evaluation.get('evaluation_criteria') %}
### è©•ä¾¡åŸºæº–

{{ phase_evaluation.evaluation_criteria }}

---
{%- endif %}
{%- endif %}
{% else %}
ãƒ•ã‚§ãƒ¼ã‚ºè©•ä¾¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
{% endif %}

{# =================================================================== #}
{# SECTION 7 (or 6 or 5): ç’°å¢ƒè¦å›  #}
{# =================================================================== #}
{% if environment_analysis %}
{% set env_text = environment_analysis if environment_analysis is string else environment_analysis.get('evaluation', environment_analysis.get('environmental', 'N/A')) %}
{% set env_rating = env_text|extract_star_rating %}
## ç’°å¢ƒè¦å› {% if env_rating.score > 0 %} ({{ env_rating.stars }} {{ env_rating.score }}/5.0){% endif %}
{% else %}
## ç’°å¢ƒè¦å› 
{% endif %}

{% if weather_data or environment_analysis %}
### æ°—è±¡æ¡ä»¶ãƒ»ç’°å¢ƒã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ

{% if weather_data %}
- **æ°—æ¸©**: {{ ((weather_data.external_temp_c|default(weather_data.temp_celsius))|round(1)) if (weather_data.external_temp_c or weather_data.temp_celsius) else "N/A" }}{{ "Â°C" if (weather_data.external_temp_c or weather_data.temp_celsius) else "" }}
- **æ¹¿åº¦**: {{ ((weather_data.humidity|default(weather_data.relative_humidity_percent))|round(1)) if (weather_data.humidity or weather_data.relative_humidity_percent) else "N/A" }}{{ "%" if (weather_data.humidity or weather_data.relative_humidity_percent) else "" }}
- **é¢¨é€Ÿ**: {{ ((weather_data.wind_speed_ms|default((weather_data.wind_speed_kmh / 3.6) if weather_data.wind_speed_kmh else 0))|round(1)) if (weather_data.wind_speed_ms or weather_data.wind_speed_kmh) else "N/A" }}{{ " m/s" if (weather_data.wind_speed_ms or weather_data.wind_speed_kmh) else "" }}
{% endif %}
{% if gear_name %}- **ä½¿ç”¨ã‚·ãƒ¥ãƒ¼ã‚º**: {{ gear_name }}
{% elif gear_type or gear_model %}- **ä½¿ç”¨ã‚·ãƒ¥ãƒ¼ã‚º**: {{ gear_type|default("") }} {{ gear_model|default("") }}
{% elif environment_analysis is mapping and environment_analysis.get('gear', {}).get('shoes') %}- **ä½¿ç”¨ã‚·ãƒ¥ãƒ¼ã‚º**: {{ environment_analysis.gear.shoes }}
{% elif environment_analysis is mapping and environment_analysis.get('environmental', {}).get('gear', {}).get('shoes') %}- **ä½¿ç”¨ã‚·ãƒ¥ãƒ¼ã‚º**: {{ environment_analysis.environmental.gear.shoes }}
{% endif %}

{% if environment_analysis %}
{{ env_rating.text_without_rating if env_rating.score > 0 else env_text }}
{% endif %}
{% else %}
ç’°å¢ƒãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
{% endif %}

---

{# =================================================================== #}
{# SECTION 8 (or 7 or 6): ğŸ’¡ æ”¹å–„ãƒã‚¤ãƒ³ãƒˆ #}
{# =================================================================== #}
## ğŸ’¡ æ”¹å–„ãƒã‚¤ãƒ³ãƒˆ

{% if summary and summary.recommendations %}
{% if training_type_category == "low_moderate" %}
ä»Šå›ã®ãƒ™ãƒ¼ã‚¹èµ°ï¼ˆæœ‰é…¸ç´ ã‚¾ãƒ¼ãƒ³ä¸­å¿ƒï¼‰ã‚’æ¬¡å›å®Ÿæ–½ã™ã‚‹éš›ã®æ”¹å–„ç‚¹ï¼š
{% elif training_type_category == "tempo_threshold" %}
ä»Šå›ã®é–¾å€¤ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’æ¬¡å›å®Ÿæ–½ã™ã‚‹éš›ã®æ”¹å–„ç‚¹ï¼š
{% elif training_type_category == "interval_sprint" %}
ä»Šå›ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’æ¬¡å›å®Ÿæ–½ã™ã‚‹éš›ã®æ”¹å–„ç‚¹ï¼š
{% endif %}

{{ summary.recommendations }}
{% else %}
æ”¹å–„ãƒã‚¤ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
{% endif %}

---

{# =================================================================== #}
{# SECTION 9 (or 8 or 7): æŠ€è¡“çš„è©³ç´° #}
{# =================================================================== #}
## æŠ€è¡“çš„è©³ç´°

<details>
<summary>ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹</summary>

### ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
- ã‚¹ãƒ—ãƒªãƒƒãƒˆãƒ‡ãƒ¼ã‚¿: DuckDB (splits table - power, stride_lengthå«ã‚€)
{% if is_interval %}- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«åŒºé–“: DuckDB (splits.intensity_type = 'active'/'rest'){% endif %}
- ãƒ•ã‚©ãƒ¼ãƒ æŒ‡æ¨™: DuckDB (form_efficiency table)
- å¿ƒæ‹ãƒ‡ãƒ¼ã‚¿: DuckDB (hr_efficiency, heart_rate_zones tables)
{% if show_physiological %}- ç”Ÿç†å­¦çš„æŒ‡æ¨™: DuckDB (vo2_max, lactate_threshold tables){% endif %}
- ç’°å¢ƒãƒ‡ãƒ¼ã‚¿: DuckDB (weather table)
- é¡ä¼¼ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆ: `mcp__garmin-db__compare_similar_workouts()`

### åˆ†æãƒãƒ¼ã‚¸ãƒ§ãƒ³
- ç”Ÿæˆæ—¥æ™‚: {{ generation_timestamp|default("N/A") }}
- ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v4.0 (BALANCED - æƒ…å ±æœ€é©åŒ–ç‰ˆ)
- æ”¹å–„é …ç›®: æ§‹æˆæœ€é©åŒ–/ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ±åˆ/ã‚¢ãƒ‰ãƒã‚¤ã‚¹å½¢å¼ã¸ã®å¤‰æ›´

</details>

---

{# =================================================================== #}
{# SECTION 10 (or 9 or 8): ğŸ“š ç”¨èªè§£èª¬ #}
{# =================================================================== #}
## ğŸ“š ç”¨èªè§£èª¬

<details>
<summary>ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹</summary>

{% if is_interval %}- **Work**: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«èµ°ã®é«˜å¼·åº¦åŒºé–“
- **Recovery**: Worké–“ã®å›å¾©åŒºé–“{% endif %}
- **GCT (Ground Contact Time)**: æ¥åœ°æ™‚é–“ã€‚ãƒšãƒ¼ã‚¹ãŒé€Ÿã„ã»ã©çŸ­ããªã‚‹
- **VO (Vertical Oscillation)**: å‚ç›´æŒ¯å¹…ã€‚èµ°è¡Œä¸­ã®ä¸Šä¸‹å‹•(ç›®æ¨™: 6-8cm)
- **VR (Vertical Ratio)**: å‚ç›´æ¯”ç‡ã€‚VOÃ·ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰é•·(ç›®æ¨™: 8-10%)
- **ãƒ‘ãƒ¯ãƒ¼**: ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ‘ãƒ¯ãƒ¼(W)
{% if show_physiological %}- **FTP (Functional Threshold Power)**: æ©Ÿèƒ½çš„é–¾å€¤ãƒ‘ãƒ¯ãƒ¼ã€‚1æ™‚é–“ç¶­æŒå¯èƒ½ãªæœ€å¤§ãƒ‘ãƒ¯ãƒ¼
- **VO2 Max**: æœ€å¤§é…¸ç´ æ‘‚å–é‡ã€‚æœ‰é…¸ç´ èƒ½åŠ›ã®æŒ‡æ¨™
- **VO2 Maxåˆ©ç”¨ç‡**: VO2 Maxãƒšãƒ¼ã‚¹ã«å¯¾ã™ã‚‹å®Ÿéš›ã®ãƒšãƒ¼ã‚¹ã®æ¯”ç‡
- **é–¾å€¤ãƒšãƒ¼ã‚¹**: ä¹³é…¸é–¾å€¤ãƒšãƒ¼ã‚¹ã€‚ç´„60åˆ†ç¶­æŒå¯èƒ½ãªæœ€é€Ÿãƒšãƒ¼ã‚¹{% endif %}
- **ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰é•·**: 1æ­©ã‚ãŸã‚Šã®è·é›¢(m)ã€‚ã‚¹ãƒ”ãƒ¼ãƒ‰ = ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹ Ã— ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰é•·

</details>

---

*ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ã€Garmin Performance Analysis System ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*
