# トレーニングタイプ別評価基準

## 概要

このドキュメントは、レポート生成時にトレーニングタイプ（training_type）に応じた適切な評価基準を適用するための仕様書です。

## トレーニングタイプ分類

Garmin DBの`hr_efficiency`テーブルから取得される`training_type`に基づき、以下の5つに分類：

| training_type | 日本語名 | 主要心拍ゾーン | 目的 |
|---------------|---------|--------------|------|
| `recovery` | リカバリー走 | Zone 1-2 (60%以上) | 疲労回復、有酸素能力維持 |
| `low_moderate`, `aerobic_base` | 有酸素ベース走 | Zone 2-3 (60%以上) | 有酸素基盤構築 |
| `tempo_threshold` | テンポ/閾値走 | Zone 3-4 (60%以上) | 閾値向上、持久力強化 |
| `interval`, `sprint` | インターバル/スプリント | Zone 4-5 (50%以上) | VO2 max向上、スピード強化 |
| その他 | 未分類 | - | 全体評価 |

---

## 評価基準の違い

### 1. パフォーマンス効率の評価対象

| トレーニングタイプ | 評価対象 | 理由 |
|------------------|---------|------|
| リカバリー走 | 全スプリット | 全体の一貫性と低強度維持が重要 |
| 有酸素ベース走 | 全スプリット | 全体の一貫性が重要 |
| テンポ/閾値走 | メイン区間のみ | ウォームアップ/クールダウンを除外 |
| インターバル/スプリント | Workセグメントのみ | 高強度区間のパフォーマンスを重視 |

**実装方法:**
- `splits.intensity_type`を使用してフィルタリング
  - テンポ/閾値走: `intensity_type = 'active'` のスプリット
  - インターバル: `intensity_type = 'active'` のスプリット（Workセグメント）
  - リカバリー/ベース走: 全スプリット

---

### 2. フェーズ評価の構成

#### リカバリー走 / 有酸素ベース走

**3フェーズ構成:**
1. **ウォームアップ** (推奨: 1-2km)
2. **メイン走行** (全体の安定性を重視)
3. **クールダウン** (推奨: 1km)

**評価基準:**

| フェーズ | 評価項目 | 目標値 |
|---------|---------|--------|
| ウォームアップ | 心拍段階的上昇 | 120 → 135bpm |
| ウォームアップ | ペース | 7:00-8:00/km |
| メイン走行 | ペース一貫性 | 変動係数<0.05 |
| メイン走行 | 心拍ゾーン | Zone 2-3を60%以上 |
| クールダウン | 心拍段階的低下 | <130bpm |
| クールダウン | ペース | 7:30-8:30/km |

---

#### テンポ走 / 閾値走

**3フェーズ構成:**
1. **ウォームアップ** (必須: 1.5-2km)
2. **メイン区間** (閾値ペース維持)
3. **クールダウン** (必須: 1-2km)

**評価基準:**

| フェーズ | 評価項目 | 目標値 |
|---------|---------|--------|
| ウォームアップ | 心拍段階的上昇 | 120 → 145bpm |
| ウォームアップ | ペース | 6:30-7:30/km |
| ウォームアップ | 距離 | 1.5-2km (必須) |
| メイン区間 | ペース一貫性 | 変動係数<0.03 |
| メイン区間 | 心拍ゾーン | Zone 3-4を70%以上 |
| メイン区間 | 閾値心拍維持 | 最大心拍の80-90% |
| クールダウン | 心拍段階的低下 | <135bpm |
| クールダウン | ペース | 7:30-8:30/km |
| クールダウン | 距離 | 1-2km (必須) |

**注意点:**
- ウォームアップ/クールダウンが不足している場合、★1-2減点
- 高強度のため、準備運動と整理運動が特に重要

---

#### インターバル / スプリント

**4フェーズ構成:**
1. **ウォームアップ** (必須: 1.5-2km)
2. **Work** (高強度区間)
3. **Recovery** (回復区間)
4. **クールダウン** (必須: 2km)

**評価基準:**

| フェーズ | 評価項目 | 目標値 |
|---------|---------|--------|
| ウォームアップ | 心拍段階的上昇 | 120 → 145bpm |
| ウォームアップ | ペース | 6:30-7:30/km |
| ウォームアップ | 距離 | 1.5-2km (必須) |
| Work | ペース一貫性 | 変動係数<0.02 |
| Work | 心拍ゾーン | Zone 4-5を50%以上 |
| Work | 最大心拍率 | 85-95% |
| Work | フォーム効率 | GCT<245ms, VO<7.5cm |
| Recovery | 回復率 | 80-85% |
| Recovery | ペース | 6:30-7:00/km |
| Recovery | 心拍低下 | 最大心拍の70-75%まで |
| クールダウン | 心拍段階的低下 | <135bpm |
| クールダウン | ペース | 7:30-8:30/km |
| クールダウン | 距離 | 2km (必須、高強度後の乳酸除去) |

**インターバル特有の指標:**
- **Work一貫性**: 全Workセグメントのペース変動係数（目標<0.02）
- **回復率**: `(Work終了時HR - Recovery終了時HR) ÷ Work終了時HR × 100`（目標80-85%）
- **心拍上昇率**: 最初のWorkと最後のWorkの心拍差（目標<5bpm）

**注意点:**
- Recovery区間が速すぎる（回復率<80%）場合、次のWorkのパフォーマンス低下
- クールダウン不足は、翌日の疲労感増加と回復遅延につながる

---

### 3. 過去データとの比較方法

#### 類似ワークアウトの定義

`mcp__garmin-db__compare_similar_workouts()`を使用して、以下の条件で検索：

| トレーニングタイプ | 距離許容範囲 | ペース許容範囲 | 地形マッチング |
|------------------|-------------|--------------|--------------|
| リカバリー走 | ±15% | ±15秒/km | 推奨 |
| 有酸素ベース走 | ±10% | ±10秒/km | 推奨 |
| テンポ/閾値走 | ±10% | ±5秒/km | 必須 |
| インターバル | Work本数一致 | ±3秒/km | 必須 |

**比較指標:**

| トレーニングタイプ | 主要比較指標 |
|------------------|-------------|
| リカバリー走 | 平均ペース、平均心拍、Zone 2分布 |
| 有酸素ベース走 | 平均ペース、平均心拍、フォーム効率 |
| テンポ/閾値走 | メイン区間ペース、閾値心拍維持率、ペース一貫性 |
| インターバル | Work平均ペース、Work一貫性、回復率、心拍上昇率 |

---

### 4. 星評価（★）の基準

#### 総合評価

| トレーニングタイプ | ★5.0 | ★4.0 | ★3.0 | ★2.0 | ★1.0 |
|------------------|------|------|------|------|------|
| リカバリー走 | 全指標目標達成、W/C完備 | 主要指標達成、W/C欠如 | ペース安定、心拍やや高 | ペース不安定 | 目的未達 |
| 有酸素ベース走 | 全指標目標達成、W/C完備 | 主要指標達成、W/C欠如 | ペース安定 | ペース不安定 | 目的未達 |
| テンポ/閾値走 | メイン区間完璧、W/C完備 | メイン区間良好、W/C欠如 | メイン区間達成 | 閾値維持失敗 | 目的未達 |
| インターバル | Work一貫性<0.02、回復率85%、W/C完備 | Work一貫性<0.03、回復率80%、W/C不足 | Work達成、回復不足 | Work不安定 | 目的未達 |

**W/C**: ウォームアップ/クールダウン

---

## 実装ガイド

### 評価対象スプリットの抽出

```python
def get_target_splits(activity_id: int, training_type: str) -> List[Split]:
    """トレーニングタイプに応じた評価対象スプリットを取得"""

    if training_type in ['recovery', 'low_moderate', 'aerobic_base']:
        # 全スプリット評価
        return get_all_splits(activity_id)

    elif training_type in ['tempo_threshold']:
        # メイン区間のみ（intensity_type = 'active'）
        return get_splits_by_intensity(activity_id, intensity_type='active')

    elif training_type in ['interval', 'sprint']:
        # Workセグメントのみ（intensity_type = 'active'）
        return get_splits_by_intensity(activity_id, intensity_type='active')

    else:
        # 未分類は全スプリット
        return get_all_splits(activity_id)
```

### フェーズ評価の生成

```python
def generate_phase_evaluation(activity_id: int, training_type: str) -> Dict:
    """トレーニングタイプに応じたフェーズ評価を生成"""

    if training_type in ['recovery', 'low_moderate', 'aerobic_base']:
        return evaluate_3_phases(activity_id, phase_names=['ウォームアップ', 'メイン走行', 'クールダウン'])

    elif training_type in ['tempo_threshold']:
        return evaluate_3_phases(activity_id, phase_names=['ウォームアップ', 'メイン区間', 'クールダウン'])

    elif training_type in ['interval', 'sprint']:
        return evaluate_4_phases(activity_id, phase_names=['ウォームアップ', 'Work', 'Recovery', 'クールダウン'])

    else:
        return evaluate_3_phases(activity_id, phase_names=['ウォームアップ', 'Run', 'クールダウン'])
```

### 類似ワークアウト検索

```python
def get_similar_workouts(activity_id: int, training_type: str) -> List[Activity]:
    """トレーニングタイプに応じた類似ワークアウトを検索"""

    tolerance_config = {
        'recovery': {'distance': 0.15, 'pace': 15, 'terrain': True},
        'low_moderate': {'distance': 0.10, 'pace': 10, 'terrain': True},
        'aerobic_base': {'distance': 0.10, 'pace': 10, 'terrain': True},
        'tempo_threshold': {'distance': 0.10, 'pace': 5, 'terrain': True},
        'interval': {'distance': 0.05, 'pace': 3, 'terrain': True},
        'sprint': {'distance': 0.05, 'pace': 3, 'terrain': True},
    }

    config = tolerance_config.get(training_type, {'distance': 0.10, 'pace': 10, 'terrain': False})

    return mcp__garmin-db__compare_similar_workouts(
        activity_id=activity_id,
        distance_tolerance=config['distance'],
        pace_tolerance=config['pace'] / 60,  # 秒→分変換
        terrain_match=config['terrain']
    )
```

---

## レポートテンプレート構成

### 共通セクション（全トレーニングタイプ）

1. 基本情報
2. パフォーマンスサマリー（過去との比較）
3. 総合評価
4. ペース・心拍推移グラフ

### トレーニングタイプ別セクション

#### リカバリー走 / 有酸素ベース走

5. パフォーマンス指標（全体評価）
   - スプリット概要（全スプリット）
   - フォーム効率（全体）
   - パフォーマンストレンド
6. フェーズ評価（3フェーズ）
7. 環境要因
8. 次回トレーニングプラン

#### テンポ走 / 閾値走

5. パフォーマンス指標（メイン区間評価）
   - スプリット概要（全スプリット、メイン区間をハイライト）
   - フォーム効率（メイン区間のみ）
   - 閾値維持率
   - パフォーマンストレンド
6. フェーズ評価（3フェーズ、ウォームアップ/クールダウンの重要性強調）
7. 環境要因
8. 次回トレーニングプラン

#### インターバル / スプリント

5. パフォーマンス指標（Workセグメント評価）
   - スプリット概要（全スプリット、Work/Recoveryを明示）
   - フォーム効率（Workセグメントのみ）
   - インターバル特有指標（Work一貫性、回復率、心拍上昇率）
   - パフォーマンストレンド
6. フェーズ評価（4フェーズ、Work/Recovery詳細分析）
7. 環境要因
8. 次回トレーニングプラン

---

## 環境要因の評価基準

### 気温評価（トレーニングタイプ別）

| トレーニングタイプ | 理想気温 | 許容範囲 | 注意範囲 |
|------------------|---------|---------|---------|
| リカバリー走 | 15-22°C | 10-25°C | <5°C, >28°C |
| 有酸素ベース走 | 10-18°C | 8-23°C | <3°C, >25°C |
| テンポ/閾値走 | 8-15°C | 5-20°C | <0°C, >23°C |
| インターバル/スプリント | 8-15°C | 5-18°C | <0°C, >20°C |

**影響度:**
- 高温（理想+5°C）: ペース+5-8秒/km、心拍+3-5bpm
- 高湿度（>80%）: ペース+5-10秒/km、体温調節困難
- 強風（>5m/s）: ペース±10-15秒/km（向かい風/追い風）

---

## 生理学的指標の活用方法

### パワー（Power）データ

**データソース**: `splits.power`, `splits.normalized_power`, `lactate_threshold.functional_threshold_power`

#### トレーニングタイプ別の活用度

| トレーニングタイプ | 重要度 | 活用方法 |
|------------------|--------|---------|
| リカバリー走 | ★☆☆☆☆ 低 | 参考程度（低パワー維持の確認） |
| 有酸素ベース走 | ★★☆☆☆ 中低 | パワー効率の長期トレンド分析 |
| テンポ/閾値走 | ★★★★☆ 高 | FTP%の維持率、閾値超過時間 |
| インターバル/スプリント | ★★★★★ 最重要 | Work一貫性、パワー低下率、Zone 5達成 |

#### 評価指標

**1. パワーゾーン分布（FTP基準）**

| ゾーン | FTP比 | 用途 | トレーニングタイプ |
|-------|------|------|------------------|
| Zone 1 | <55% | 回復 | リカバリー走 |
| Zone 2 | 56-75% | 有酸素 | ベース走（目標70-80%） |
| Zone 3 | 76-90% | テンポ | テンポ走（目標80-90%） |
| Zone 4 | 91-105% | 閾値 | 閾値走（目標95-105%） |
| Zone 5 | 106-120% | VO2 Max | インターバル（目標105-115%） |
| Zone 6 | >121% | 無酸素 | スプリント（数十秒のみ維持可能） |

**2. パワー効率（Power Efficiency）**

```python
# パワー/ペース比（低いほど効率的）
power_efficiency = average_power / (1 / pace_seconds_per_km)

# 類似ワークアウトとの比較
efficiency_improvement = (previous_power - current_power) / previous_power * 100
# 例: 前回230W、今回225W → 効率2.2%向上
```

**3. パワー一貫性（Work/メイン区間）**

```python
# Work一貫性（変動係数）
power_cv = std(work_powers) / mean(work_powers)

# 目標値
# - インターバル: <0.03（±10W以内）
# - テンポ/閾値走: <0.05（±15W以内）
```

**4. パワー低下率（疲労指標）**

```python
# 最初と最後のWork/区間の比較
power_decline = (first_work_power - last_work_power) / first_work_power * 100

# 評価基準
# - <3%: 優秀（疲労管理良好）
# - 3-5%: 許容範囲
# - >5%: 要改善（Recoveryペース調整が必要）
```

---

### ストライド長（Stride Length）データ

**データソース**: `splits.stride_length`, `splits.cadence`

#### トレーニングタイプ別の理想値

| トレーニングタイプ | 理想ストライド長 | 理想ケイデンス | 備考 |
|------------------|---------------|--------------|------|
| リカバリー走 | 1.10-1.20m | 155-165 spm | 低ストライド・低ケイデンス |
| 有酸素ベース走 | 1.15-1.25m | 160-170 spm | 自然なストライド |
| テンポ/閾値走 | 1.25-1.35m | 170-180 spm | ストライド拡大 |
| インターバル/スプリント | 1.35-1.50m | 180-190 spm | 最大推進力 |

**注**: 身長・脚長により個人差あり。上記は身長170cm前後の目安。

#### 評価指標

**1. スピード分解（Speed = Cadence × Stride Length）**

```python
# スピード（m/s）計算
speed_mps = (cadence_spm × stride_length_m) / 60

# ペース（秒/km）変換
pace_sec_per_km = 1000 / speed_mps

# 例: ケイデンス182spm、ストライド1.42m
# → スピード = 182 × 1.42 / 60 = 4.31 m/s
# → ペース = 1000 / 4.31 = 232秒/km = 3:52/km
```

**2. ケイデンス×ストライドのバランス**

| パターン | ケイデンス | ストライド | 評価 | 改善案 |
|---------|-----------|-----------|------|--------|
| **最適** | 高 | 長 | ★★★★★ | 維持 |
| 高回転・短歩 | 高 | 短 | ★★★☆☆ | ストライド拡大（筋力強化） |
| 低回転・長歩 | 低 | 長 | ★★★☆☆ | ケイデンス向上（怪我リスク） |
| **非効率** | 低 | 短 | ★★☆☆☆ | 両方改善 |

**3. ストライド長の一貫性**

```python
# ストライド変動係数
stride_cv = std(stride_lengths) / mean(stride_lengths)

# 評価基準
# - <0.02: 優秀（疲労下でも維持）
# - 0.02-0.05: 良好
# - >0.05: 要改善（疲労によるフォーム崩れ）
```

**4. 疲労による短縮率**

```python
# 最初と最後のWork/区間の比較
stride_decline = (first_stride - last_stride) / first_stride * 100

# 評価基準
# - <2%: 優秀（フォーム維持）
# - 2-5%: 許容範囲
# - >5%: 要改善（フォーム崩れ、筋力不足）
```

---

### VO2 Max データ

**データソース**: `vo2_max.precise_value`, `vo2_max.category`, `vo2_max.fitness_age`

#### トレーニングタイプ別の活用度

| トレーニングタイプ | 重要度 | 活用方法 |
|------------------|--------|---------|
| リカバリー走 | ★☆☆☆☆ 低 | 参考程度（長期トレンド） |
| 有酸素ベース走 | ★★☆☆☆ 中低 | 長期トレンド、基盤構築の確認 |
| テンポ/閾値走 | ★★★☆☆ 中高 | VO2 Max利用率の算出 |
| インターバル/スプリント | ★★★★★ 最重要 | VO2 Maxペース達成、向上効果測定 |

#### 評価指標

**1. VO2 Maxカテゴリ（年齢・性別別）**

| カテゴリ | 男性（35歳） | 女性（35歳） |
|---------|------------|------------|
| 優秀 | >51 | >45 |
| 良好 | 43-51 | 38-45 |
| 平均 | 35-42 | 31-37 |
| 低い | <35 | <31 |

**2. VO2 Maxペースの推定**

```python
# Daniels' Running Formula に基づく推定
# VO2 Max 52.3 ml/kg/min の場合:
# - VO2 Maxペース（3-8分維持可能）: 約4:25-4:35/km
# - 閾値ペース（約1時間維持可能）: 約4:35-4:45/km

# 簡易計算式（近似）
vo2_max_pace_sec_km = 1000 / (vo2_max_value * 0.2)  # 簡易式
# 例: VO2 Max 52.3 → ペース ≈ 4:30/km
```

**3. VO2 Max利用率（インターバル/テンポ走）**

```python
# 現在のペースでのVO2 Max利用率
vo2_utilization = (vo2_max_pace_sec_km / current_pace_sec_km) * 100

# 評価基準（インターバル）
# - 90-100%: 理想的なVO2 Max刺激 ✅
# - 85-90%: 良好（VO2 Max向上効果あり）
# - <85%: 不十分（ペースアップが必要）
# - >100%: 過度（無酸素領域、数分のみ維持可能）

# 評価基準（テンポ/閾値走）
# - 75-85%: 理想的な閾値刺激 ✅
# - <75%: 有酸素ベース走レベル
# - >85%: 高強度過ぎ（長時間維持困難）
```

**4. VO2 Max向上の目標設定**

```python
# インターバルトレーニングの効果
# - 週1-2回の実施で、4-8週間で2-3%向上が期待できる
# - 例: 52.3 → 53.5-54.0 ml/kg/min

# フィットネス年齢の改善
# - 1 ml/kg/min向上 ≈ フィットネス年齢-1歳
# - 例: VO2 Max 52.3（28歳） → 54.0（26歳）
```

---

### 閾値（Lactate Threshold）データ

**データソース**: `lactate_threshold.heart_rate`, `lactate_threshold.speed_mps`, `lactate_threshold.functional_threshold_power`

#### トレーニングタイプ別の活用度

| トレーニングタイプ | 重要度 | 活用方法 |
|------------------|--------|---------|
| リカバリー走 | ★☆☆☆☆ 低 | 参考程度（閾値から十分離れているか確認） |
| 有酸素ベース走 | ★★☆☆☆ 中低 | 閾値以下の確認 |
| テンポ/閾値走 | ★★★★★ 最重要 | 閾値維持率、閾値向上効果測定 |
| インターバル/スプリント | ★★★★☆ 高 | 閾値超過率、Zone 5達成確認 |

#### 評価指標

**1. 閾値心拍ゾーン（最大心拍基準）**

| 指標 | 最大心拍比 | 用途 |
|------|----------|------|
| 回復ゾーン | <70% | リカバリー走 |
| 有酸素ゾーン | 70-80% | ベース走 |
| テンポゾーン | 80-85% | テンポ走 |
| **閾値** | **85-90%** | **閾値走（1時間維持可能）** |
| VO2 Maxゾーン | 90-95% | インターバル |
| 最大ゾーン | >95% | スプリント |

**2. 閾値ペース/パワーの維持率（テンポ/閾値走）**

```python
# 閾値心拍維持率
threshold_hr_time = time_in_zone(168 - 5, 168 + 5)  # ±5bpm
threshold_hr_percentage = threshold_hr_time / total_time * 100

# 評価基準
# - >70%: 優秀（閾値走として完璧）✅
# - 50-70%: 良好
# - <50%: 不十分（強度調整が必要）

# 閾値パワー維持率（FTP基準）
threshold_power_time = time_in_zone(FTP * 0.95, FTP * 1.05)  # FTPの95-105%
threshold_power_percentage = threshold_power_time / total_time * 100
```

**3. 閾値超過率（インターバル）**

```python
# 閾値を超過した時間（Zone 4-5）
above_threshold_time = time_above(threshold_hr)
above_threshold_percentage = above_threshold_time / total_time * 100

# 評価基準（インターバル）
# - Workセグメント合計3-8分: 理想的なVO2 Max刺激 ✅
# - <3分: 不十分（本数またはWorkペースアップ）
# - >8分: 過度（回復時間延長のリスク）
```

**4. 閾値の長期トレンド**

| 指標 | 初期値 | 4週間後目標 | 8週間後目標 |
|------|--------|-----------|-----------|
| 閾値心拍 | 168 bpm | 170 bpm | 172 bpm |
| 閾値ペース | 4:35/km | 4:30/km | 4:25/km |
| FTP | 285W | 290W | 295W |

**閾値向上の条件:**
- 週1回のテンポ/閾値走（8-12km @ 閾値ペース）
- 週1回のインターバル（Work合計3-5分 @ VO2 Maxペース）
- 十分な回復（48-72時間）

---

---

## フォーム効率のペース補正評価

### 基本原則

フォーム効率指標（GCT、VO、VR）は**ペースに依存**するため、絶対値だけでなく「そのペースに対して効率的か」を評価する必要があります。

### ペース別の基準値

#### 1. 接地時間（GCT: Ground Contact Time）

**ペースとGCTの関係:**
- 速いペースほど接地時間が短くなる（推進力を素早く得る必要があるため）
- リカバリー走（遅いペース）で接地時間が長いのは正常

| ペース範囲 | 理想GCT | 良好範囲 | 要改善 |
|-----------|---------|---------|--------|
| <4:00/km (スプリント) | 220-235ms | 235-245ms | >245ms |
| 4:00-4:30/km (インターバル) | 230-240ms | 240-250ms | >250ms |
| 4:30-5:30/km (テンポ/閾値) | 240-250ms | 250-260ms | >260ms |
| 5:30-6:30/km (ベース走) | 250-260ms | 260-270ms | >270ms |
| >6:30/km (リカバリー) | 260-275ms | 275-285ms | >285ms |

**ペース補正評価式:**

```python
# 基準GCT（ペースから推定）
def get_baseline_gct(pace_sec_per_km: float) -> float:
    """ペースに基づく基準GCT（ms）を算出"""
    # 線形近似: 4:00/km→230ms、7:00/km→270ms
    # y = 230 + (pace - 240) * 0.22
    baseline_gct = 230 + (pace_sec_per_km - 240) * 0.22
    return baseline_gct

# GCT効率スコア（-100〜+100、0が基準、マイナスが良い）
def gct_efficiency_score(actual_gct: float, pace_sec_per_km: float) -> float:
    baseline = get_baseline_gct(pace_sec_per_km)
    score = ((actual_gct - baseline) / baseline) * 100
    return score

# 評価
# score < -5%: 優秀（基準より5%以上短い）
# -5% <= score <= +5%: 良好（基準±5%以内）
# score > +5%: 要改善（基準より5%以上長い）
```

**例:**
```python
# ベース走: 6:45/km (405秒)、GCT 253ms
baseline = 230 + (405 - 240) * 0.22 = 266.3ms
score = ((253 - 266.3) / 266.3) * 100 = -5.0%
評価: ★★★★☆ 優秀（基準より5%短い）

# インターバル: 4:28/km (268秒)、GCT 238ms
baseline = 230 + (268 - 240) * 0.22 = 236.2ms
score = ((238 - 236.2) / 236.2) * 100 = +0.8%
評価: ★★★★★ 優秀（基準±5%以内）
```

---

#### 2. 垂直振幅（VO: Vertical Oscillation）

**ペースとVOの関係:**
- ペースが速くなると若干増加する傾向があるが、効率的なランナーは抑制できる
- 理想的には6-8cm範囲を維持（ペースに関わらず）

| ペース範囲 | 理想VO | 良好範囲 | 要改善 |
|-----------|--------|---------|--------|
| <4:00/km (スプリント) | 6.5-7.5cm | 7.5-8.5cm | >8.5cm |
| 4:00-5:00/km (インターバル/テンポ) | 6.5-7.5cm | 7.5-8.5cm | >8.5cm |
| 5:00-6:00/km (ベース走) | 6.5-7.5cm | 7.5-8.5cm | >8.5cm |
| >6:00/km (リカバリー) | 7.0-8.0cm | 8.0-9.0cm | >9.0cm |

**ペース補正評価式:**

```python
# 基準VO（ペースから推定）
def get_baseline_vo(pace_sec_per_km: float) -> float:
    """ペースに基づく基準VO（cm）を算出"""
    # 緩やかな増加: 4:00/km→6.8cm、7:00/km→7.5cm
    # y = 6.8 + (pace - 240) * 0.004
    baseline_vo = 6.8 + (pace_sec_per_km - 240) * 0.004
    return baseline_vo

# VO効率スコア
def vo_efficiency_score(actual_vo: float, pace_sec_per_km: float) -> float:
    baseline = get_baseline_vo(pace_sec_per_km)
    score = ((actual_vo - baseline) / baseline) * 100
    return score

# 評価
# score < -5%: 優秀（基準より5%以上低い）
# -5% <= score <= +5%: 良好
# score > +5%: 要改善（基準より5%以上高い）
```

**例:**
```python
# ベース走: 6:45/km (405秒)、VO 7.13cm
baseline = 6.8 + (405 - 240) * 0.004 = 7.46cm
score = ((7.13 - 7.46) / 7.46) * 100 = -4.4%
評価: ★★★★☆ 優秀（基準より4.4%低い）

# インターバル: 4:28/km (268秒)、VO 6.84cm
baseline = 6.8 + (268 - 240) * 0.004 = 6.91cm
score = ((6.84 - 6.91) / 6.91) * 100 = -1.0%
評価: ★★★★★ 優秀（基準とほぼ一致）
```

---

#### 3. 垂直比率（VR: Vertical Ratio）

**ペースとVRの関係:**
- VRは**ペースに依存しない**（VO÷ストライド長なので、両方がペースで変化するため）
- どのペースでも8-10%が理想

| ペース範囲 | 理想VR | 良好範囲 | 要改善 |
|-----------|--------|---------|--------|
| 全ペース | 8.0-9.5% | 9.5-10.5% | >10.5% |

**評価式（ペース補正不要）:**

```python
# VR評価（ペース補正なし）
def vr_efficiency_score(actual_vr: float) -> str:
    if actual_vr < 8.0:
        return "★★★★★ 優秀（理想より低い、極めて効率的）"
    elif 8.0 <= actual_vr <= 9.5:
        return "★★★★★ 優秀（理想範囲）"
    elif 9.5 < actual_vr <= 10.5:
        return "★★★★☆ 良好"
    elif 10.5 < actual_vr <= 11.5:
        return "★★★☆☆ 要改善"
    else:
        return "★★☆☆☆ 非効率（ストライド長を拡大すべき）"
```

---

### フォーム効率の総合評価

**ペース補正後の総合スコア:**

```python
def form_efficiency_rating(gct_ms: float, vo_cm: float, vr_percent: float, pace_sec_per_km: float) -> dict:
    """ペース補正後のフォーム効率総合評価"""

    # 各指標のスコア算出
    gct_score = gct_efficiency_score(gct_ms, pace_sec_per_km)
    vo_score = vo_efficiency_score(vo_cm, pace_sec_per_km)

    # VRはペース補正不要
    if 8.0 <= vr_percent <= 9.5:
        vr_score = 0  # 理想範囲
    else:
        vr_score = abs(vr_percent - 8.75) / 8.75 * 100  # 8.75%を中心とした偏差

    # 総合スコア（平均）
    total_score = (abs(gct_score) + abs(vo_score) + abs(vr_score)) / 3

    # 星評価
    if total_score < 3:
        rating = "★★★★★ 5.0/5.0"
    elif total_score < 5:
        rating = "★★★★☆ 4.5/5.0"
    elif total_score < 7:
        rating = "★★★★☆ 4.0/5.0"
    elif total_score < 10:
        rating = "★★★☆☆ 3.5/5.0"
    else:
        rating = "★★★☆☆ 3.0/5.0"

    return {
        "gct_score": gct_score,
        "vo_score": vo_score,
        "vr_score": vr_score,
        "total_score": total_score,
        "rating": rating,
        "baseline_gct": get_baseline_gct(pace_sec_per_km),
        "baseline_vo": get_baseline_vo(pace_sec_per_km)
    }
```

**評価例:**

```python
# ベース走: 6:45/km、GCT 253ms、VO 7.13cm、VR 8.89%
result = form_efficiency_rating(253, 7.13, 8.89, 405)
# {
#   "gct_score": -5.0%,  # 優秀（基準266.3msより短い）
#   "vo_score": -4.4%,   # 優秀（基準7.46cmより低い）
#   "vr_score": 1.6%,    # 優秀（理想8.75%に近い）
#   "total_score": 3.7,  # 平均偏差
#   "rating": "★★★★☆ 4.5/5.0",
#   "baseline_gct": 266.3,
#   "baseline_vo": 7.46
# }

# インターバル: 4:28/km、GCT 238ms、VO 6.84cm、VR 8.24%
result = form_efficiency_rating(238, 6.84, 8.24, 268)
# {
#   "gct_score": +0.8%,  # 優秀（基準236.2msとほぼ一致）
#   "vo_score": -1.0%,   # 優秀（基準6.91cmとほぼ一致）
#   "vr_score": 5.8%,    # 良好（理想8.75%に近い）
#   "total_score": 2.5,  # 平均偏差
#   "rating": "★★★★★ 5.0/5.0",
#   "baseline_gct": 236.2,
#   "baseline_vo": 6.91
# }
```

---

### レポートでの表示例

**フォーム効率セクション:**

```markdown
### フォーム効率（ペース補正評価） (★★★★☆ 4.5/5.0)

**主要指標（ペース6:45/km基準）:**
- **平均接地時間**: 253.0ms (基準: 266.3ms, **-5.0%** 優秀 ✅)
  - そのペースに対して基準より5%短く、効率的な接地
  - 絶対値評価: ★★★★☆、ペース補正評価: ★★★★★
- **平均垂直振幅**: 7.13cm (基準: 7.46cm, **-4.4%** 優秀 ✅)
  - そのペースに対して基準より4.4%低く、無駄な上下動を抑制
  - 絶対値評価: ★★★★☆、ペース補正評価: ★★★★☆
- **平均垂直比率**: 8.89% (理想: 8.0-9.5%, ペース補正不要 ✅)
  - 理想範囲内、効率的な推進
  - 評価: ★★★★★

**総合評価:**
6:45/kmという中強度ペースに対して、全てのフォーム指標が基準以上の効率を示しています。
特にGCT（-5.0%）は優秀で、同じペースの平均的なランナーより効率的な接地ができています。
```

---

### データ統合分析

#### パワー × ストライド × VO2 Max × 閾値の総合評価

**1. 効率マトリクス（インターバル）**

| Work | ペース | パワー | ストライド | 心拍 | 総合効率 |
|------|--------|--------|----------|------|---------|
| W1 | 4:28/km | 310W (109%) | 1.42m | 170 bpm | ★★★★☆ |
| W2 | 4:26/km | 315W (111%) | 1.43m | 172 bpm | ★★★★★ 最高 |
| W5 | 4:30/km | 305W (107%) | 1.40m | 175 bpm | ★★★☆☆ 低下 |

**総合効率 = (ペース評価 + パワー効率 + ストライド最適性) / 3**

**2. 生理学的負荷指標（Training Stress Score風）**

```python
# 簡易TSS計算（NP: Normalized Power、FTP: Functional Threshold Power）
TSS = (duration_hours × NP × intensity_factor) / (FTP × 3600) × 100

# intensity_factor = NP / FTP
# 例: 1時間、NP=250W、FTP=285W
# → IF = 250/285 = 0.88
# → TSS = (1 × 250 × 0.88) / (285 × 1) × 100 ≈ 77

# TSS評価
# - <50: 低負荷（リカバリー）
# - 50-100: 中負荷（ベース/テンポ走）
# - 100-200: 高負荷（閾値/インターバル）
# - >200: 非常に高負荷（要十分な回復）
```

**3. 次回トレーニングの推奨（全指標統合）**

| 現状 | 次回推奨 | 理由 |
|------|---------|------|
| VO2 Max利用率90%達成 | インターバル継続（1週間後） | VO2 Max向上継続 |
| 閾値心拍70%維持 | テンポ走継続（週1回） | 閾値向上継続 |
| パワー-5W低下（効率向上） | 同ペース継続 | 効率維持 |
| ストライド-3cm短縮（疲労） | 筋力トレーニング追加 | フォーム改善 |

---

## まとめ

### 実装時のチェックリスト

- [ ] `hr_efficiency.training_type`を取得
- [ ] トレーニングタイプに応じた評価対象スプリットを抽出
- [ ] 適切なフェーズ評価（3 or 4フェーズ）を生成
- [ ] 類似ワークアウトを適切な許容範囲で検索
- [ ] 星評価基準をトレーニングタイプに合わせて適用
- [ ] レポートテンプレートを選択
- [ ] 環境評価をトレーニングタイプに合わせて調整

### テスト項目

- [ ] リカバリー走のレポート生成
- [ ] 有酸素ベース走のレポート生成
- [ ] テンポ/閾値走のレポート生成（メイン区間評価）
- [ ] インターバル走のレポート生成（Work/Recovery分析）
- [ ] 類似ワークアウト比較の動作確認
- [ ] フェーズ評価の動作確認

---

## 参考資料

- `CLAUDE.md`: システム概要とMCPツール一覧
- サンプルレポート（v3.0 - パワー・ストライド・VO2 Max・閾値対応）:
  - ベース走: `result/individual/2025/10/2025-10-08_20625808856_SAMPLE_v3.md`
  - インターバル走: `result/individual/2025/10/2025-10-15_interval_SAMPLE_v3.md`
