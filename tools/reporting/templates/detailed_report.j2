# ランニング分析レポート

{%- set training_type_category = training_type_category|default("low_moderate") -%}
{%- set show_physiological = training_type_category in ["tempo_threshold", "interval_sprint"] -%}
{%- set is_interval = training_type_category == "interval_sprint" -%}

{# =================================================================== #}
{# SECTION 1: 基本情報 #}
{# =================================================================== #}
## 基本情報
- **日付**: {{ date }}
- **アクティビティID**: {{ activity_id }}
{% if activity_name %}- **アクティビティ名**: {{ activity_name }}{% endif %}
{% if basic_metrics.start_time %}- **開始時刻**: {{ basic_metrics.start_time }}{% endif %}
{% if basic_metrics.distance_km %}- **距離**: {{ "%.2f"|format(basic_metrics.distance_km) }} km{% endif %}
{% if basic_metrics.duration_seconds %}- **所要時間**: {{ (basic_metrics.duration_seconds // 60)|int }}分{{ "%02d"|format((basic_metrics.duration_seconds % 60)|int) }}秒 ({{ basic_metrics.duration_seconds|int }}秒){% endif %}
{% if basic_metrics.avg_pace_seconds_per_km %}- **平均ペース**: {{ (basic_metrics.avg_pace_seconds_per_km / 60)|int }}:{{ "%02d"|format((basic_metrics.avg_pace_seconds_per_km % 60)|int) }}/km{% endif %}
- **[Garmin Connectで見る](https://connect.garmin.com/modern/activity/{{ activity_id }})**

---

## 📊 パフォーマンスサマリー
{%- if show_physiological and lactate_threshold_data %}

### 生理学的指標サマリー

| 指標 | 現在値 | 評価 |
|------|--------|------|
{%- if vo2_max_data %}
| **VO2 Max** | {{ vo2_max_data.precise_value|default(vo2_max_data.value)|default(0) }} ml/kg/min | カテゴリ: {{ vo2_max_data.category|default("N/A") }} |
{%- endif %}
{%- if vo2_max_utilization %}
| **VO2 Max利用率** | {{ vo2_max_utilization }}% | {{ vo2_max_utilization_eval|default("N/A") }} |
{%- endif %}
| **閾値ペース** | {{ threshold_pace_formatted|default("N/A") }}/km | {{ threshold_pace_comparison|default("N/A") }} |
| **FTP(パワー)** | {{ lactate_threshold_data.functional_threshold_power|default(0)|int }} W | Work平均{{ work_avg_power|int if work_avg_power else "N/A" }}W = FTPの{{ ftp_percentage|default("N/A") }}% |

{% endif %}

### 類似ワークアウトとの比較

{%- if similar_workouts %}
{%- if similar_workouts.pace_source == "main_set" %}
過去の同条件ワークアウト({{ similar_workouts.conditions }}、**メインセットペース比較**)との比較:
{%- else %}
過去の同条件ワークアウト({{ similar_workouts.conditions }})との比較:
{%- endif %}

| 指標 | 今回 | 類似{{ similar_workouts.count }}回平均 | 変化 | トレンド |
|------|------|------------|------|----------|
{%- for comp in similar_workouts.comparisons %}
| {{ comp.metric }} | {{ comp.current }} | {{ comp.average }} | {{ comp.change }} | {{ comp.trend }} |
{%- endfor %}

**💡 インサイト**: {{ similar_workouts.insight }}
{%- else %}
類似ワークアウトが見つかりませんでした。
{%- endif %}
{%- if reference_info %}

{{ reference_info }}
{%- endif %}

---

## 総合評価
{%- if summary %}

### アクティビティタイプ
{%- if activity_type %}
**{{ activity_type.ja }}** ({{ activity_type.en }})

{{ activity_type.description }}
{%- else %}
N/A
{%- endif %}

### 総合所見{% if summary.star_rating %} ({{ summary.star_rating }}){% endif %}

{{ summary.summary if summary.summary else "評価データがありません。" }}

{% if summary.key_strengths %}
**✅ 優れている点:**
{% for strength in summary.key_strengths -%}
- {{ strength }}
{% endfor %}
{% endif %}

{% if summary.improvement_areas %}
**⚠️ 改善可能な点:**
{% for area in summary.improvement_areas -%}
- {{ area }}
{% endfor %}
{% endif %}
{% endif %}

### ペース・心拍{% if show_physiological %}・パワー{% endif %}推移{% if is_interval %}(Work/Recoveryハイライト){% endif %}

{% if mermaid_data %}
```mermaid
xychart-beta
    title "スプリット別 ペース・心拍{% if show_physiological %}・パワー{% endif %}推移"
    x-axis {{ mermaid_data.x_axis_labels | tojson }}
    y-axis "ペース(秒/km)" {{ mermaid_data.pace_min }} --> {{ mermaid_data.pace_max }}
    y-axis "心拍(bpm)" {{ mermaid_data.hr_min }} --> {{ mermaid_data.hr_max }}
    line {{ mermaid_data.pace_data | tojson }}
    line {{ mermaid_data.heart_rate_data | tojson }}
    {% if show_physiological and mermaid_data.power_data %}
    line {{ mermaid_data.power_data | tojson }}
    {% endif %}
```

{% if is_interval %}
**凡例**: 青=ペース(秒/km)、橙=心拍(bpm)、緑=パワー(W)

**分析**:
{{ interval_graph_analysis|default("N/A") }}
{% endif %}
{% else %}
グラフデータがありません。
{% endif %}

---

{# =================================================================== #}
{# SECTION 4: パフォーマンス指標 #}
{# =================================================================== #}
## パフォーマンス指標

{% if is_interval %}
> **評価対象**: {{ target_segments_description|default("Workセグメント") }}(インターバル走は高強度区間のパフォーマンスを重視)
{% endif %}

### スプリット概要{% if is_interval %}(全区間){% endif %}

{% if splits and splits|length > 0 %}
| # | {% if is_interval %}タイプ | {% endif %}ペース | 心拍 | ケイデンス | パワー | ストライド | GCT | VO | VR | 標高 |
|---|{% if is_interval %}-------|{% endif %}--------|------|------------|--------|------------|-----|----|----|------|
{%- for split in splits %}
| {{ split.index }} | {% if is_interval %}{{ splits|format_intensity_type(split.index) }} | {% endif %}{{ split.pace_formatted }}/km | {{ split.heart_rate|int }} bpm | {{ split.cadence|int if split.cadence else "-" }} spm | {{ split.power|int if split.power else "-" }} W | {{ "%.2f"|format(split.stride_length) if split.stride_length else "-" }} m | {{ split.ground_contact_time|int if split.ground_contact_time else "-" }} ms | {{ "%.1f"|format(split.vertical_oscillation) if split.vertical_oscillation else "-" }} cm | {{ "%.1f"|format(split.vertical_ratio) if split.vertical_ratio else "-" }}% | +{{ split.elevation_gain|int if split.elevation_gain else 0 }}/-{{ split.elevation_loss|int if split.elevation_loss else 0 }}m |
{%- endfor %}

**📈 {% if is_interval %}Workセグメント {% endif %}ハイライト:**
{{ highlights_list|default("N/A") }}

<details>
<summary>📋 {% if is_interval %}Work/Recovery{% else %}スプリット{% endif %}詳細分析(クリックで展開)</summary>

{% if split_analysis %}
{% if split_analysis is mapping %}
{%- set analyses_dict = split_analysis.get("analyses", split_analysis) %}
{% for key, value in analyses_dict.items() | sort_splits %}
### {{ key }}
{{ value }}

{% endfor %}
{% else %}
{{ split_analysis }}
{% endif %}
{% else %}
詳細分析データがありません。
{% endif %}

</details>
{% else %}
スプリットデータがありません。
{% endif %}

---

{% set efficiency_text = efficiency.evaluation if efficiency.evaluation else efficiency if efficiency is string else "フォーム効率データがありません。" %}
{% set efficiency_rating = efficiency_text|extract_star_rating %}
### フォーム効率({% if is_interval %}Workセグメント {% endif %}ペース補正評価){% if efficiency.overall_form_score %} ({{ efficiency.overall_form_score }}){% elif efficiency_rating.score > 0 %} ({{ efficiency_rating.stars }} {{ efficiency_rating.score }}/5.0){% endif %}

{% if efficiency %}
{% if efficiency.form_efficiency_table or efficiency.form_indicators %}
{# New structured format #}
{% set form_table = efficiency.form_efficiency_table or efficiency.form_indicators %}
| 指標 | 実測値 | ペース基準値 | 補正スコア | 評価 |
|------|--------|------------|-----------|------|
{%- for item in form_table %}
| **{{ item.metric_name }}** | {{ item.actual_value }} | {{ item.baseline_value }} | {{ item.adjusted_score }} | {{ item.rating }} |
{%- endfor %}

{% if efficiency.overall_form_score %}**総合フォーム効率: {{ efficiency.overall_form_score }}**{% endif %}

{% if efficiency.efficiency_text %}{{ efficiency.efficiency_text }}{% endif %}

{% if efficiency.hr_efficiency_text %}**心拍効率:**
{{ efficiency.hr_efficiency_text }}{% endif %}
{% else %}
{# Legacy format #}
{% if is_interval %}
```mermaid
pie title "心拍ゾーン分布(全体)"
{{ heart_rate_zone_pie_data|default("") }}
```
{% else %}
```mermaid
pie title "心拍ゾーン分布"
{{ heart_rate_zone_pie_data|default("") }}
```
{% endif %}

{{ efficiency_rating.text_without_rating if efficiency_rating.score > 0 else efficiency_text }}
{% endif %}
{% else %}
フォーム効率データがありません。
{% endif %}

---

{% if show_physiological %}
{# =================================================================== #}
{# SECTION 5: 生理学的指標との関連 (Tempo/Interval only) #}
{# =================================================================== #}
## 生理学的指標との関連

### VO2 Max活用度

{% if vo2_max_data %}
- **現在のVO2 Max**: {{ vo2_max_data.precise_value|default(vo2_max_data.value)|default(0) }} ml/kg/min({{ vo2_max_data.category|default("N/A") }})
- **{% if is_interval %}Work{% else %}メイン区間{% endif %}平均心拍**: {{ run_metrics.avg_hr|default("N/A")|int if run_metrics.avg_hr else "N/A" }} bpm
- **VO2 Max利用率**: 約{{ vo2_max_utilization|default("N/A") }}%({{ vo2_max_utilization_eval|default("N/A") }})

**期待効果**: {{ vo2_max_expected_effect|default("N/A") }}
{% else %}
VO2 Maxデータがありません。
{% endif %}

### 閾値超過度

{% if lactate_threshold_data %}
- **閾値心拍**: {{ lactate_threshold_data.heart_rate|default(0)|int }} bpm
- **{% if is_interval %}Work{% else %}メイン区間{% endif %}平均心拍**: {{ run_metrics.avg_hr|default("N/A")|int if run_metrics.avg_hr else "N/A" }} bpm
- **閾値パワー(FTP)**: {{ lactate_threshold_data.functional_threshold_power|default(0)|int }} W
- **{% if is_interval %}Work{% else %}メイン区間{% endif %}平均パワー**: {{ work_avg_power|default("N/A")|int if work_avg_power else "N/A" }} W(FTPの{{ ftp_percentage|default("N/A") }}%) → {{ power_zone_name|default("N/A") }} ✅

**期待効果**: {{ threshold_expected_effect|default("N/A") }}
{% else %}
閾値データがありません。
{% endif %}

---

{% endif %}

{# =================================================================== #}
{# SECTION 6 (or 5): フェーズ評価 #}
{# =================================================================== #}
## フェーズ評価

{%- if phase_evaluation %}
{%- if phase_evaluation.get('warmup_evaluation') or phase_evaluation.get('warmup') or training_type_category == "recovery" %}
{%- set warmup_text = phase_evaluation.get('warmup_evaluation', phase_evaluation.get('warmup', {}).get('evaluation', 'データがありません。')) %}
{%- set warmup_rating = warmup_text|extract_star_rating %}
### ウォームアップフェーズ{% if warmup_rating.score > 0 %} ({{ warmup_rating.stars }} {{ warmup_rating.score }}/5.0){% endif %}

{{ warmup_rating.text_without_rating if warmup_rating.score > 0 else warmup_text }}

{%- if training_type_category == "recovery" %}
{# Recovery run - only 1 phase, end here #}
---
{%- endif %}
{%- endif %}

{%- if training_type_category != "recovery" %}
{%- if phase_evaluation.get('run_evaluation') or phase_evaluation.get('run') or phase_evaluation.get('main') %}
{%- set run_text = phase_evaluation.get('run_evaluation', phase_evaluation.get('run', {}).get('evaluation', phase_evaluation.get('main', {}).get('evaluation', 'データがありません。'))) %}
{%- set run_rating = run_text|extract_star_rating %}

---

### {% if is_interval %}Workフェーズ{% else %}メイン走行フェーズ{% endif %}{% if run_rating.score > 0 %} ({{ run_rating.stars }} {{ run_rating.score }}/5.0){% endif %}

{{ run_rating.text_without_rating if run_rating.score > 0 else run_text }}
{%- endif %}

{%- if is_interval and (phase_evaluation.get('recovery_evaluation') or phase_evaluation.get('recovery')) %}
{%- set recovery_text = phase_evaluation.get('recovery_evaluation', phase_evaluation.get('recovery', {}).get('evaluation', 'データがありません。')) %}
{%- set recovery_rating = recovery_text|extract_star_rating %}

---

### Recoveryフェーズ{% if recovery_rating.score > 0 %} ({{ recovery_rating.stars }} {{ recovery_rating.score }}/5.0){% endif %}

{{ recovery_rating.text_without_rating if recovery_rating.score > 0 else recovery_text }}
{%- endif %}

{%- if phase_evaluation.get('cooldown_evaluation') or phase_evaluation.get('cooldown') or phase_evaluation.get('finish') %}
{%- set cooldown_text = phase_evaluation.get('cooldown_evaluation', phase_evaluation.get('cooldown', {}).get('evaluation', phase_evaluation.get('finish', {}).get('evaluation', 'データがありません。'))) %}
{%- set cooldown_rating = cooldown_text|extract_star_rating %}

---

### クールダウンフェーズ{% if cooldown_rating.score > 0 %} ({{ cooldown_rating.stars }} {{ cooldown_rating.score }}/5.0){% endif %}

{{ cooldown_rating.text_without_rating if cooldown_rating.score > 0 else cooldown_text }}

---
{%- endif %}
{%- endif %}
{% else %}
フェーズ評価データがありません。
{% endif %}

{# =================================================================== #}
{# SECTION 7 (or 6 or 5): 環境要因 #}
{# =================================================================== #}
{% if environment_analysis %}
{% set env_text = environment_analysis if environment_analysis is string else environment_analysis.get('evaluation', environment_analysis.get('environmental', 'N/A')) %}
{% set env_rating = env_text|extract_star_rating %}
## 環境要因{% if env_rating.score > 0 %} ({{ env_rating.stars }} {{ env_rating.score }}/5.0){% endif %}
{% else %}
## 環境要因
{% endif %}

{% if weather_data or environment_analysis %}
### 気象条件・環境インパクト

{% if weather_data %}
- **気温**: {{ (weather_data.external_temp_c|default(weather_data.temp_celsius))|round(1) }}°C
- **湿度**: {{ (weather_data.humidity|default(weather_data.relative_humidity_percent))|round(1) }}%
- **風速**: {{ (weather_data.wind_speed_ms|default((weather_data.wind_speed_kmh|default(0)) / 3.6 if weather_data.wind_speed_kmh else 0))|round(1) }} m/s
{% endif %}
{% if gear_name %}- **使用シューズ**: {{ gear_name }}
{% elif gear_type or gear_model %}- **使用シューズ**: {{ gear_type|default("") }} {{ gear_model|default("") }}
{% elif environment_analysis is mapping and environment_analysis.get('gear', {}).get('shoes') %}- **使用シューズ**: {{ environment_analysis.gear.shoes }}
{% elif environment_analysis is mapping and environment_analysis.get('environmental', {}).get('gear', {}).get('shoes') %}- **使用シューズ**: {{ environment_analysis.environmental.gear.shoes }}
{% endif %}

{% if environment_analysis %}
{{ env_rating.text_without_rating if env_rating.score > 0 else env_text }}
{% endif %}
{% else %}
環境データがありません。
{% endif %}

---

{# =================================================================== #}
{# SECTION 8 (or 7 or 6): 💡 改善ポイント #}
{# =================================================================== #}
## 💡 改善ポイント

{% if summary and summary.recommendations %}
{{ summary.recommendations }}
{% else %}
改善ポイントデータがありません。
{% endif %}

---

{# =================================================================== #}
{# SECTION 9 (or 8 or 7): 技術的詳細 #}
{# =================================================================== #}
## 技術的詳細

<details>
<summary>クリックで展開</summary>

### データソース
- スプリットデータ: DuckDB (splits table - power, stride_length含む)
{% if is_interval %}- インターバル区間: DuckDB (splits.intensity_type = 'active'/'rest'){% endif %}
- フォーム指標: DuckDB (form_efficiency table)
- 心拍データ: DuckDB (hr_efficiency, heart_rate_zones tables)
{% if show_physiological %}- 生理学的指標: DuckDB (vo2_max, lactate_threshold tables){% endif %}
- 環境データ: DuckDB (weather table)
- 類似ワークアウト: `mcp__garmin-db__compare_similar_workouts()`

### 分析バージョン
- 生成日時: {{ generation_timestamp|default("N/A") }}
- システムバージョン: v4.0 (BALANCED - 情報最適化版)
- 改善項目: 構成最適化/セクション統合/アドバイス形式への変更

</details>

---

{# =================================================================== #}
{# SECTION 10 (or 9 or 8): 📚 用語解説 #}
{# =================================================================== #}
## 📚 用語解説

<details>
<summary>クリックで展開</summary>

{% if is_interval %}- **Work**: インターバル走の高強度区間
- **Recovery**: Work間の回復区間{% endif %}
- **GCT (Ground Contact Time)**: 接地時間。ペースが速いほど短くなる
- **VO (Vertical Oscillation)**: 垂直振幅。走行中の上下動(目標: 6-8cm)
- **VR (Vertical Ratio)**: 垂直比率。VO÷ストライド長(目標: 8-10%)
- **パワー**: ランニングパワー(W)
{% if show_physiological %}- **FTP (Functional Threshold Power)**: 機能的閾値パワー。1時間維持可能な最大パワー
- **VO2 Max**: 最大酸素摂取量。有酸素能力の指標
- **VO2 Max利用率**: VO2 Maxペースに対する実際のペースの比率
- **閾値ペース**: 乳酸閾値ペース。約60分維持可能な最速ペース{% endif %}
- **ストライド長**: 1歩あたりの距離(m)。スピード = ケイデンス × ストライド長
- **ペース補正評価**: そのペースに対する相対評価(同じペースのランナーと比較)

</details>

---

*このレポートは、Garmin Performance Analysis System により自動生成されました。*
